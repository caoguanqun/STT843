---
title: "Lab03b: The Multivariate Normal Distribution"
subtitle: "STT 843: Multivariate Analysis"
author: "Dr. Guanqun Cao"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

``` R
{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(MASS)       # For mvrnorm
library(matrixcalc) # For matrix properties
```

## 1. Introduction to the Multivariate Normal Distribution (MND)

If $\boldsymbol{X} \sim N_p(\boldsymbol{\mu}, \Sigma)$ , then any linear
combination $\mathbf{A}\boldsymbol{X}$ is also normally distributed.

### Exercise 1: Linear Combinations (Example 3.4)

Let $\boldsymbol{X} \sim N_3(\boldsymbol{\mu}, \Sigma)$ where:

$$\boldsymbol{\mu} = \begin{bmatrix} 1 \\ 2 \\ 3 \end{bmatrix}, \Sigma = \begin{bmatrix} 4 & 1 & 0 \\ 1 & 3 & 0 \\ 0 & 0 & 2 \end{bmatrix}$$

We want to find the distribution of $\mathbf{A}\boldsymbol{X}$ where
$\mathbf{A} = \begin{bmatrix} 1 & -1 & 0 \\ 0 & 1 & -1 \end{bmatrix}$.

``` R
# Define parameters
mu <- c(1, 2, 3)
Sigma <- matrix(c(4, 1, 0, 
                  1, 3, 0, 
                  0, 0, 2), nrow = 3, byrow = TRUE)
A <- matrix(c(1, -1, 0, 
              0, 1, -1), nrow = 2, byrow = TRUE)

# Theoretical New Mean: A * mu
new_mu <- A %*% mu

# Theoretical New Covariance: A * Sigma * A^T
new_Sigma <- A %*% Sigma %*% t(A)

print("New Mean Vector:")
print(new_mu)
print("New Covariance Matrix:")
print(new_Sigma)
```

**Task:** Use `mvrnorm` to simulate 10,000 points from the original
$N_3$ distribution, transform them using matrix $A$, and check if the
sample mean and covariance match your theoretical results above.

## 2. Independence and Subsets (Example 3.6)

A key property of the MND is that zero covariance implies independence.

**Question:** Based on the $\Sigma$ matrix provided in Exercise 1:

1.  Are $X_1$ and $X_2$ independent?

2.  Are $(X_1, X_2)$ and $X_3$ independent?

``` R
# X1 and X2 covariance
cov_12 <- Sigma[1,2]

# Covariance matrix between (X1, X2) and X3
Sigma_12_3 <- Sigma[1:2, 3]

cat("Cov(X1, X2) is:", cov_12, "\n")
cat("Cov((X1, X2), X3) is:", Sigma_12_3, "\n")
```

## 3. Conditional Distributions (Example 3.7)

If $\boldsymbol{X}$ is partitioned into $\boldsymbol{X}_1$ and
$\boldsymbol{X}_2$, the conditional distribution of
$\boldsymbol{X}_1 | \boldsymbol{X}_2 = \mathbf{x}_2$ is normal with:

$$
\text{Mean} = \boldsymbol{\mu}_1 + \Sigma_{12} \Sigma_{22}^{-1}(\mathbf{x}_2 - \boldsymbol{\mu}_2)
$$

$$\text{Cov} = \Sigma_{11} - \Sigma_{12} \Sigma_{22}^{-1} \Sigma_{21}$$

### Exercise 2: Calculate Conditional Mean

Given the same $\boldsymbol{\mu}$ and $\Sigma$ as Exercise 1, find the
conditional distribution of $X_1$ given $X_2 = 5$.

``` R
mu1 <- mu[1]
mu2 <- mu[2]
sigma11 <- Sigma[1,1]
sigma12 <- Sigma[1,2]
sigma22 <- Sigma[2,2]
x2 <- 5

# Conditional Mean
cond_mu <- mu1 + sigma12 * solve(sigma22) * (x2 - mu2)

# Conditional Variance
cond_var <- sigma11 - sigma12 * solve(sigma22) * sigma12

cat("Conditional Mean of X1 | X2=5 is:", cond_mu, "\n")
cat("Conditional Variance is:", cond_var, "\n")
```

## 4. Maximum Likelihood Estimation (MLE)

For a random sample
$\boldsymbol{X}_1, \dots, \boldsymbol{X}_n \sim N_p(\boldsymbol{\mu}, \Sigma)$,
the MLEs are:

$$
\hat{\boldsymbol{\mu}} = \bar{\boldsymbol{X}}, \quad \hat{\Sigma} = \frac{n-1}{n}\mathbf{S}
$$

### Exercise 3: Implementation of MLE

1.  Simulate a sample of size $n=100$ from a $N_2$ distribution.

2.  Calculate the MLE of $\boldsymbol{\mu}$ and $\Sigma$.

3.  Verify the **Invariance Property**: Calculate the MLE of the
    correlation coefficient $\rho_{12}$.

``` R
set.seed(123)
n <- 100
true_mu <- c(5, 10)
true_Sigma <- matrix(c(1, 0.5, 0.5, 1), nrow = 2)

# Simulate data
data_sample <- mvrnorm(n, mu = true_mu, Sigma = true_Sigma)

# MLE for mu
mle_mu <- colMeans(data_sample)

# MLE for Sigma (Note: R's cov() uses n-1, MLE uses n)
S <- cov(data_sample)
mle_Sigma <- ((n - 1) / n) * S

# Invariance Property: MLE of correlation
mle_rho <- mle_Sigma[1,2] / (sqrt(mle_Sigma[1,1]) * sqrt(mle_Sigma[2,2]))

print(mle_mu)
print(mle_Sigma)
print(paste("MLE of Correlation:", round(mle_rho, 4)))
```
