---
title: "Lab03a: The Multivariate Normal Distribution"
subtitle: "STT 843: Multivariate Analysis"
author: "Dr. Guanqun Cao"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

## Introduction

In this lab, we will visualize the Multivariate Normal (MVN)
distribution, explore how the covariance matrix $\Sigma$ affects the
shape of the density, and verify the Chi-square property for probability
contours.

``` r
{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(mvtnorm) # For multivariate normal functions
library(ellipse) # For drawing contours
```

## 1. Defining the Parameters

From the lecture, we know a bivariate normal distribution is defined by
a mean vector $\boldsymbol{\mu}$ and a covariance matrix $\Sigma$.

``` r
# Define the mean vector mu
mu <- c(1, 2)

# Define the covariance matrix Sigma (Example: sigma11=1, sigma22=1, rho=0.75)
rho <- 0.75
sigma11 <- 1
sigma22 <- 1
sigma12 <- rho * sqrt(sigma11) * sqrt(sigma22)

Sigma <- matrix(c(sigma11, sigma12, 
                  sigma12, sigma22), nrow = 2)

print("Mean Vector:")
print(mu)
print("Covariance Matrix:")
print(Sigma)
```

## 2. Visualizing the Bivariate Density

We can visualize the "bell shape" in 3D using the `dmvnorm` function.

``` r
# Create a grid for X and Y
x <- seq(-2, 4, length.out = 50)
y <- seq(-1, 5, length.out = 50)
grid <- expand.grid(x = x, y = y)

# Calculate density values
z <- dmvnorm(as.matrix(grid), mean = mu, sigma = Sigma)
z_matrix <- matrix(z, nrow = 50)

# Plot 3D surface
persp(x, y, z_matrix, theta = 30, phi = 30, col = "lightblue", 
      shade = 0.75, main = "3D Bivariate Normal Density")
```

## 3. Constant Probability Contours

The lecture states that contours are ellipsoids centered at
$\boldsymbol{\mu}$. Let's plot the $50\%$ and $95\%$ probability
contours.

``` r
plot(NULL, xlim = c(-2, 4), ylim = c(-1, 5), 
     xlab = "X1", ylab = "X2", main = "Probability Contours")

# Plot 50% contour
lines(ellipse(Sigma, centre = mu, level = 0.50), col = "blue", lwd = 2)
# Plot 95% contour
lines(ellipse(Sigma, centre = mu, level = 0.95), col = "red", lwd = 2)

points(mu[1], mu[2], pch = 19, col = "black") # Mean center
legend("topleft", legend = c("50%", "95%"), col = c("blue", "red"), lty = 1)
```

## 4. Eigenvalues and the Shape of the Ellipse

The axes of the ellipses are determined by the eigenvectors of $\Sigma$,
and the lengths are proportional to $\sqrt{\lambda_i}$.

``` r
# Calculate eigenvalues and eigenvectors
ev <- eigen(Sigma)

print("Eigenvalues (Lengths):")
print(ev$values)

print("Eigenvectors (Directions):")
print(ev$vectors)
```

**Exercise:** Notice that the first eigenvector points in the direction
of the greatest spread (the major axis of the ellipse).

## 5. The Chi-Square Property

The squared Mahalanobis distance
$(\mathbf{x}-\boldsymbol{\mu})^{\top} \Sigma^{-1}(\mathbf{x}-\boldsymbol{\mu})$
should follow a $\chi^2$ distribution with $p=2$ degrees of freedom.

``` r
# Generate 1000 random samples from our MVN distribution
set.seed(123)
samples <- rmvnorm(1000, mean = mu, sigma = Sigma)

# Calculate squared distance for each sample
dist_sq <- mahalanobis(samples, center = mu, cov = Sigma)

# Compare sample distribution to Chi-square (df=2) using a Q-Q plot
qqplot(qchisq(ppoints(1000), df = 2), dist_sq,
       main = "Chi-Square Q-Q Plot",
       xlab = "Theoretical Chi-square Quantiles",
       ylab = "Sample Squared Distances")
abline(0, 1, col = "red")
```
