---
title: "Lab05a:  One-Way MANOVA"
subtitle: "STT 843: Multivariate Analysis"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(car)      # For MANOVA and Wilks' test
library(mvtnorm)  # For data simulation
```

## 1. Introduction to MANOVA

In this lab, we will apply the One-Way MANOVA (Multivariate Analysis of
Variance) to compare the mean vectors of $g$ groups. We assume:

\$\$\\mathbf{x}\_{\\ell j} = \\boldsymbol{\\mu} +
\\boldsymbol{\\tau}\_{\\ell} + \\mathbf{e}\_{\\ell j}\$\$

where $\mathbf{e}_{\ell j} \sim N(\mathbf{0}, \boldsymbol{\Sigma})$.

## 2. Data Preparation/Simulation

Let's simulate a dataset with $g=3$ groups and $p=2$ dependent variables
($X_1, X_2$) to demonstrate the process.

``` r
set.seed(42)
n_group <- 30
# Common Covariance Matrix Sigma
Sigma <- matrix(c(1, 0.5, 0.5, 1), nrow = 2)

# Group Means (Treatment Effects)
mu1 <- c(2, 2)
mu2 <- c(2.5, 3)
mu3 <- c(2, 4)

# Generate Data
group1 <- rmvnorm(n_group, mean = mu1, sigma = Sigma)
group2 <- rmvnorm(n_group, mean = mu2, sigma = Sigma)
group3 <- rmvnorm(n_group, mean = mu3, sigma = Sigma)

df <- data.frame(
  Group = factor(rep(c("A", "B", "C"), each = n_group)),
  X1 = c(group1[,1], group2[,1], group3[,1]),
  X2 = c(group1[,2], group2[,2], group3[,2])
)

# Visualize the groups
ggplot(df, aes(x = X1, y = X2, color = Group)) +
  geom_point(alpha = 0.6) +
  stat_ellipse() +
  theme_minimal() +
  labs(title = "Bivariate Data by Group")
```

## 3. The MANOVA Table

We decompose the variance into the **H** (Hypothesis/Treatment) matrix
and **E** (Error) matrix.

``` r
# Bind response variables
Y <- cbind(df$X1, df$X2)

# Fit the MANOVA model
fit <- manova(Y ~ Group, data = df)

# Summary using Wilks' Lambda (Likelihood Ratio Test)
summary(fit, test = "Wilks")
```

## 4. Comparing the Four Test Statistics

As discussed in the lecture, there are four common multivariate tests.
Let's compare them:

\| Statistic \| Function \| Sensitivity / Property \| \| :--- \| :--- \|
:--- \| \| \*\*Wilks' \$\\Lambda\$\*\* \| \$\\prod\_{i=1}\^{s}
\\frac{1}{1+\\lambda_i}\$ \| General purpose (Likelihood Ratio); rejects
for \*\*small\*\* values. \| \| \*\*Pillai's Trace\*\* \|
\$\\sum\_{i=1}\^{s} \\frac{\\lambda_i}{1+\\lambda_i}\$ \| Most robust to
violations of assumptions (like unequal covariance). \| \|
\*\*Hotelling-Lawley\*\* \| \$\\sum\_{i=1}\^{s} \\lambda_i\$ \| Similar
to Wilks, based on \$tr(\\mathbf{E}\^{-1}\\mathbf{H})\$. \| \| \*\*Roy's
Largest Root\*\* \| \$\\lambda_1\$ \| Most powerful if group differences
are concentrated on a single dimension. \|

| Statistic | Function | Sensitivity |
|----|----|----|
| **Wilks' Lambda** | $\prod \frac{1}{1+\lambda_i}$ | General purpose (Likelihood Ratio) |
| Pillai's Trace | $\sum \frac{\lambda_i}{1+\lambda_i}$ | Most robust to violations of assumptions |
| Hotelling-Lawley | $\sum \lambda_i$ | Similar to Wilks, based on $E^{-1}H$ |
| Roy's Largest Root | $\lambda_1$ | Most powerful if differences are on 1 dimension |

``` r
# Pillai's Trace (default in R)
summary(fit, test = "Pillai")

# Hotelling-Lawley
summary(fit, test = "Hotelling-Lawley")

# Roy's Largest Root
summary(fit, test = "Roy")
```

## 5. Simultaneous Confidence Intervals (Bonferroni)

If the MANOVA is significant, we look for which components and group
pairs differ. We use the Bonferroni correction:
\$\$t\_{n-g}\\left(\\frac{\\alpha}{pg(g-1)}\\right)\$\$

``` r
# Example for X1 between Group A and B
n <- nrow(df)
g <- 3
p <- 2
alpha <- 0.05
m <- p * g * (g-1) / 2 # Number of comparisons

# Extract Error Matrix E
E <- abs(summary(fit)$SS$Residuals)
s_pooled_X1 <- sqrt(E[1,1] / (n - g))

# T-critical value
t_crit <- qt(1 - (alpha / (2 * m)), df = n - g)

# Mean difference
diff_X1_AB <- mean(df$X1[df$Group == "B"]) - mean(df$X1[df$Group == "A"])
se_diff <- s_pooled_X1 * sqrt(1/n_group + 1/n_group)

# Interval
cat("95% SCI for X1 (Group B - A):", 
    diff_X1_AB - t_crit * se_diff, "to", diff_X1_AB + t_crit * se_diff)
```
